<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Test Reports by Run ID</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
          background: #f8f9fa;
          padding: 20px;
          font-family: Arial, sans-serif;
          min-height: 100vh;
          display: flex;
          overflow-x: hidden;
        }

        /* Sidebar */
        #sidebar {
          width: 250px;
          background: #fff;
          color: #000;
          flex-shrink: 0;
          border-right: 1px solid #ddd;
          height: 100vh;
          position: fixed;
          top: 0;
          left: 0;
          z-index: 1050;
          padding-top: 1rem;
        }

        #sidebar .logo {
          text-align: center;
          margin-bottom: 1rem;
        }
        #sidebar .logo img {
          max-width: 100%;
          height: auto;
        }

        #sidebar .nav-link {
          color: #000;
          padding-left: 1rem;
          white-space: nowrap;
          display: block;
          padding: 0.5rem 1rem;
          transition: background-color 0.3s;
        }

        #sidebar .nav-link.active, #sidebar .nav-link:hover {
          background: #f0f0f0;
          color: #000;
          text-decoration: none;
        }

        /* Main content */
        #main-content {
          margin-left: 250px;
          padding: 20px;
          flex-grow: 1;
          overflow-y: auto;
          min-width: 0;
        }

        #runIdButtons {
          margin-bottom: 20px;
        }

        #runIdButtons button {
          margin: 3px;
          padding: 5px 10px;
          font-size: 0.9rem;
        }

        #runIdButtons button.active {
          background-color: #0d6efd;
          color: white;
          border-color: #0d6efd;
        }

        .error-cell {
          max-width: 300px;
          white-space: pre-wrap;
          color: red;
        }

        .screenshot-img {
          max-width: 150px;
          max-height: 100px;
          object-fit: contain;
        }

        .details-btn {
          cursor: pointer;
          font-weight: bold;
          font-size: 1.2rem;
          user-select: none;
        }

        .details-row {
          background-color: #f1f1f1;
        }

        .details-content {
          white-space: pre-wrap;
          font-family: monospace;
          color: #333;
          padding: 10px;
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<nav id="sidebar">
    <div class="logo">
        <img style="max-width: 80%; height: auto;" src="/logo.png" alt="Şirket Logo" />
    </div>
    <ul class="nav flex-column p-2">
        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" href="report.html">Reports</a></li>
    </ul>
</nav>

<!-- Main content -->
<div id="main-content">
    <h1>Test Reports by Run ID</h1>

    <div id="runIdButtons" class="mb-3"></div>

    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-bordered table-hover" id="resultsTable">
            <thead class="table-light">
            <tr>
                <th></th>
                <th>Scenario</th>
                <th>Status</th>
                <th>Duration (ms)</th>
                <th>Timestamp</th>
                <th>Screenshot</th>
                <th>Error Message</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let executions = [];
    let filteredExecutions = [];
    const runIdButtonsDiv = document.getElementById('runIdButtons');
    const tbody = document.querySelector('#resultsTable tbody');

    async function loadExecutions() {
      try {
        const res = await fetch('/executions');  // Burada kendi endpoint adresin
        const data = await res.json();

        if (!Array.isArray(data)) {
          console.error('Sunucudan beklenen formatta array gelmedi:', data);
          return;
        }

        executions = data;

        // Son 20 benzersiz runId'yi bul
        let runIds = [...new Set(executions.map(e => e.runId).filter(r => r))];
        runIds = runIds.slice(-20); // son 20 runId

        renderRunIdButtons(runIds);

        // Varsayılan olarak son runId seçili
        if (runIds.length > 0) {
          filterAndRender(runIds[runIds.length - 1]);
          setActiveButton(runIds[runIds.length - 1]);
        }

      } catch (e) {
        console.error('Veri yüklenirken hata:', e);
      }
    }

    function renderRunIdButtons(runIds) {
      runIdButtonsDiv.innerHTML = '';
      runIds.forEach(runId => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-outline-primary btn-sm';
        btn.textContent = runId;
        btn.onclick = () => {
          filterAndRender(runId);
          setActiveButton(runId);
        };
        runIdButtonsDiv.appendChild(btn);
      });
    }

    function setActiveButton(runId) {
      [...runIdButtonsDiv.children].forEach(btn => {
        btn.classList.toggle('active', btn.textContent === runId);
      });
    }

    function filterAndRender(runId) {
      filteredExecutions = executions.filter(e => e.runId === runId);
      renderTable(filteredExecutions);
    }

    function renderTable(data) {
      tbody.innerHTML = '';

      data.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.classList.add('main-row');
        tr.dataset.index = index;
        tr.innerHTML = `
          <td class="details-btn" aria-label="Toggle details">+</td>
          <td>${item.scenario}</td>
          <td>${item.status}</td>
          <td>${item.duration}</td>
          <td>${new Date(item.timestamp).toLocaleString()}</td>
          <td>${item.screenshot ? `<img src="${item.screenshot}" class="screenshot-img" />` : '-'}</td>
          <td class="error-cell">-</td>
        `;
        tbody.appendChild(tr);

        const detailsTr = document.createElement('tr');
        detailsTr.classList.add('details-row');
        detailsTr.style.display = 'none';
        detailsTr.innerHTML = `
          <td colspan="7" class="details-content">
            <strong>Details:</strong><br/>
            Scenario: ${item.scenario}<br/>
            Status: ${item.status}<br/>
            Duration: ${item.duration} ms<br/>
            Timestamp: ${new Date(item.timestamp).toLocaleString()}<br/>
            <strong>Error Message:</strong> ${item.error ? item.error : '-'}<br/>
            ${item.screenshot ? `<img src="${item.screenshot}" style="max-width: 400px; max-height: 250px; margin-top: 10px;" />` : ''}
          </td>
        `;
        tbody.appendChild(detailsTr);
      });

      // Detay butonlarını etkinleştir
      document.querySelectorAll('.details-btn').forEach(btn => {
        btn.onclick = () => {
          const tr = btn.parentElement;
          const nextTr = tr.nextElementSibling;
          if (nextTr.style.display === 'none') {
            nextTr.style.display = '';
            btn.textContent = '−';
          } else {
            nextTr.style.display = 'none';
            btn.textContent = '+';
          }
        };
      });
    }

    // Sayfa yüklenince veriyi çek
    loadExecutions();

</script>

</body>
</html>
