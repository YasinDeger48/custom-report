<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Test Reports by Run ID</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
          background: #f8f9fa;
          padding: 20px;
          font-family: Arial, sans-serif;
          min-height: 100vh;
          display: flex;
          overflow-x: hidden;
        }

        /* Sidebar */
        #sidebar {
          width: 250px;
          background: #fff;
          color: #000;
          flex-shrink: 0;
          border-right: 1px solid #ddd;
          height: 100vh;
          position: fixed;
          top: 0;
          left: 0;
          z-index: 1050;
          padding-top: 1rem;
        }

        #sidebar.collapsed {
            width: 70px;
        }

        #sidebar.collapsed .logo,
        #sidebar.collapsed .nav-link span {
            display: none;
        }

        #sidebar.collapsed .nav-link.active .vertical-text {
            display: block;
        }

        #sidebar.collapsed .nav-link {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px;
        }

        .nav-link .vertical-text {
            display: none;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            text-align: center;
            font-weight: bold;
            letter-spacing: 2px;
            font-size: 1rem;
        }

        #sidebar .logo {
          text-align: center;
          margin-bottom: 1rem;
        }
        #sidebar .logo img {
          max-width: 100%;
          height: auto;
        }

        #sidebar .nav-link {
          color: #000;
          padding-left: 1rem;
          white-space: nowrap;
          display: block;
          padding: 0.5rem 1rem;
          transition: background-color 0.3s;
        }

        #sidebar .nav-link.active, #sidebar .nav-link:hover {
          background: #f0f0f0;
          color: #000;
          text-decoration: none;
        }

        /* Main content */
        #main-content {
          margin-left: 250px;
          padding: 20px;
          transition: margin-left 0.3s ease;
          width: 100%;
          overflow-y: auto;
          min-height: 100vh;
        }

        #main-content.collapsed {
            margin-left: 70px;
        }

        .toggle-btn-container {
            position: fixed;
            bottom: 15px;
            left: 15px;
            z-index: 1050;
        }

        .toggle-btn {
            font-size: 1.5rem;
            padding: 0.5rem 0.75rem;
        }

        #runIdContainer {
          margin-bottom: 20px;
        }

        .error-cell {
          max-width: 300px;
          white-space: pre-wrap;
          color: red;
        }

        .screenshot-img {
          max-width: 150px;
          max-height: 100px;
          object-fit: contain;
        }

        .details-btn {
          cursor: pointer;
          font-weight: bold;
          font-size: 1.2rem;
          user-select: none;
        }

        .details-row {
          background-color: #f1f1f1;
        }

        .details-content {
          white-space: pre-wrap;
          font-family: monospace;
          color: #333;
          padding: 10px;
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<nav id="sidebar">
    <div class="logo">
        <img style="max-width: 80%; height: auto;" src="/logo.png" alt="Şirket Logo" />
    </div>
    <ul class="nav flex-column p-2">
        <li class="nav-item"><a class="nav-link" href="/dashboard">
            <span>Dashboard</span>
            <span class="vertical-text">DASHBOARD</span>
        </a></li>
        <li class="nav-item"><a class="nav-link active" href="/reports">
            <span>Reports</span>
            <span class="vertical-text">REPORTS</span>
        </a></li>
    </ul>
</nav>

<!-- Main content -->
<div id="main-content">
    <div class="toggle-btn-container">
        <button class="toggle-btn btn btn-sm btn-light" id="sidebarToggle" aria-label="Toggle Menu">&#9776;</button>
    </div>

    <div class="container-fluid">
        <h1 class="mt-4">Test Reports by Run ID</h1>

        <div id="runIdContainer" class="mb-3"></div>

        <div id="actionButtons" class="mb-3" style="display: none;">
            <button id="downloadPdfBtn" class="btn btn-success btn-sm">Download PDF</button>
            <button id="deleteSelectedBtn" class="btn btn-danger btn-sm">Delete Selected</button>
        </div>

        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-bordered table-hover" id="resultsTable">
                <thead class="table-light">
                <tr>
                    <th></th>
                    <th>Scenario</th>
                    <th>Status</th>
                    <th>Duration (ms)</th>
                    <th>Timestamp</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById('sidebarToggle').addEventListener('click', function () {
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.getElementById('main-content').classList.toggle('collapsed');
    });

    let executions = [];
    let filteredExecutions = [];
    let activeRunId = null;
    const runIdContainerDiv = document.getElementById('runIdContainer');
    const tbody = document.querySelector('#resultsTable tbody');

    async function loadExecutions() {
      try {
        const res = await fetch('/executions');  // Burada kendi endpoint adresin
        const data = await res.json();

        if (!Array.isArray(data)) {
          console.error('Sunucudan beklenen formatta array gelmedi:', data);
          return;
        }

        executions = data;

        // Son 20 benzersiz runId'yi bul
        let runIds = [...new Set(executions.map(e => e.runId).filter(r => r))];
        runIds = runIds.slice(-20); // son 20 runId

        renderRunIdCheckboxes(runIds);

        // Varsayılan olarak son runId seçili
        if (runIds.length > 0) {
          const latestRunId = runIds[runIds.length - 1];
          filterAndRender(latestRunId);
          setActiveLabel(latestRunId);
        }

      } catch (e) {
        console.error('Veri yüklenirken hata:', e);
      }
    }

    function renderRunIdCheckboxes(runIds) {
      runIdContainerDiv.innerHTML = '';
      runIds.forEach(runId => {
        const formCheck = document.createElement('div');
        formCheck.className = 'form-check form-check-inline';

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'form-check-input';
        input.value = runId;
        input.id = `check-${runId}`;

        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.htmlFor = `check-${runId}`;
        label.textContent = runId;
        label.style.cursor = 'pointer';
        label.onclick = (e) => {
            e.preventDefault(); // prevent label from toggling checkbox
            filterAndRender(runId);
            setActiveLabel(runId);
        };

        formCheck.appendChild(input);
        formCheck.appendChild(label);
        runIdContainerDiv.appendChild(formCheck);
      });

      // Add action buttons logic
      const actionButtonsDiv = document.getElementById('actionButtons');
      if (runIds.length > 0) {
          actionButtonsDiv.style.display = 'block';
      } else {
          actionButtonsDiv.style.display = 'none';
      }

      document.getElementById('deleteSelectedBtn').onclick = deleteSelectedReports;
    }

    function setActiveLabel(runId) {
      document.querySelectorAll('#runIdContainer .form-check-label').forEach(label => {
          if (label.textContent === runId) {
              label.style.fontWeight = 'bold';
              label.style.textDecoration = 'underline';
          } else {
              label.style.fontWeight = 'normal';
              label.style.textDecoration = 'none';
          }
      });
    }

    function filterAndRender(runId) {
      activeRunId = runId;
      filteredExecutions = executions.filter(e => e.runId === runId);
      renderTable(filteredExecutions);

      // Configure buttons for the active runId
      document.getElementById('downloadPdfBtn').onclick = () => {
          window.location.href = `/pdf?runId=${runId}`;
      };
    }

    function renderTable(data) {
      tbody.innerHTML = '';

      data.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.classList.add('main-row');
        tr.dataset.index = index;
        tr.innerHTML = `
          <td class="details-btn" aria-label="Toggle details">+</td>
          <td>${item.scenario}</td>
          <td>${item.status}</td>
          <td>${item.duration}</td>
          <td>${new Date(item.timestamp).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);

        const detailsTr = document.createElement('tr');
        detailsTr.classList.add('details-row');
        detailsTr.style.display = 'none';
        detailsTr.innerHTML = `
          <td colspan="5" class="details-content">
            <strong>Details:</strong><br/>
            Scenario: ${item.scenario}<br/>
            Status: ${item.status}<br/>
            Duration: ${item.duration} ms<br/>
            Timestamp: ${new Date(item.timestamp).toLocaleString()}<br/>
            <strong>Error Message:</strong> ${item.error ? item.error : '-'}<br/>
            ${item.screenshot ? `<img src="${item.screenshot}" style="max-width: 400px; max-height: 250px; margin-top: 10px;" />` : ''}
          </td>
        `;
        tbody.appendChild(detailsTr);
      });

      // Detay butonlarını etkinleştir
      document.querySelectorAll('.details-btn').forEach(btn => {
        btn.onclick = () => {
          const tr = btn.parentElement;
          const nextTr = tr.nextElementSibling;
          if (nextTr.style.display === 'none') {
            nextTr.style.display = '';
            btn.textContent = '−';
          } else {
            nextTr.style.display = 'none';
            btn.textContent = '+';
          }
        };
      });
    }

    async function deleteSelectedReports() {
        const selectedRunIds = Array.from(document.querySelectorAll('#runIdContainer input[type="checkbox"]:checked'))
                                    .map(cb => cb.value);

        if (selectedRunIds.length === 0) {
            alert('Silinecek en az bir rapor seçmelisiniz.');
            return;
        }

        if (confirm(`${selectedRunIds.length} adet raporu silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`)) {
            try {
                const response = await fetch(`/executions`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(selectedRunIds)
                });

                if (response.ok) {
                    alert('Seçilen raporlar başarıyla silindi.');
                    location.reload(); // Sayfayı yenile
                } else {
                    const errorText = await response.text();
                    alert(`Raporlar silinirken hata: ${errorText}`);
                }
            } catch (error) {
                console.error('Raporlar silinirken hata oluştu:', error);
                alert('Raporlar silinirken bir hata oluştu.');
            }
        }
    }

    // Sayfa yüklenince veriyi çek
    loadExecutions();

</script>

</body>
</html>
